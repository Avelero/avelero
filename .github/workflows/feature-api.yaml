name: Feature API Deploy
permissions:
  contents: read
  pull-requests: write
on:
  push:
    branches:
      - 'feature/**'
      - 'feat/**'
    paths:
      - apps/api/**
      - packages/**
      - "!packages/email/**"
      - "!packages/ui/**"
jobs:
  deploy:
    name: ðŸš€ Deploy Feature API to Fly
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: ðŸ”¦ Run linter
        run: bun run lint
        working-directory: ./apps/api
      - name: ðŸª Check TypeScript
        run: bun run typecheck
        working-directory: ./apps/api
      
      # Create a branch-specific Fly app name
      - name: Set Fly app name
        id: fly-app
        run: |
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9-]/-/g' | cut -c1-30)
          APP_NAME="avelero-api-${BRANCH_NAME}"
          echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT
          echo "Deploying to: ${APP_NAME}"
      
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      # Deploy to branch-specific Fly app
      - name: Deploy to Fly
        run: |
          flyctl deploy --remote-only \
            --dockerfile apps/api/Dockerfile \
            --config apps/api/fly-preview.yml \
            --app ${{ steps.fly-app.outputs.app_name }} \
            --auto-confirm || flyctl apps create ${{ steps.fly-app.outputs.app_name }} && \
          flyctl deploy --remote-only \
            --dockerfile apps/api/Dockerfile \
            --config apps/api/fly-preview.yml \
            --app ${{ steps.fly-app.outputs.app_name }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN_STAGING }}
      
      - name: Get deployment URL
        id: deploy-url
        run: |
          URL="https://${{ steps.fly-app.outputs.app_name }}.fly.dev"
          echo "url=${URL}" >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ API Preview deployed to: ${{ steps.deploy-url.outputs.url }}'
            })