name: Preview Deploy Orchestrator

on:
  # Run on every push to feature branches
  push:
    branches:
      - 'feature/**'
      - 'feat/**'
    paths:
      - apps/**
      - packages/**

  # Deploy preview only on PR to main
  pull_request:
    types: [opened, reopened, synchronize, closed]
    branches:
      - main
    paths:
      - apps/**
      - packages/**

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # Step 1: Detect which components changed
  # ============================================
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      app_changed: ${{ steps.filter.outputs.app }}
      api_changed: ${{ steps.filter.outputs.api }}
      jobs_changed: ${{ steps.filter.outputs.jobs }}
      dpp_changed: ${{ steps.filter.outputs.dpp }}
      web_changed: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            app:
              - 'apps/app/**'
              - 'packages/**'
            api:
              - 'apps/api/**'
              - 'packages/**'
              - '!packages/email/**'
              - '!packages/ui/**'
            jobs:
              - 'packages/jobs/**'
              - 'packages/db/**'
              - 'packages/supabase/**'
              - 'packages/email/**'
              - 'packages/utils/**'
            dpp:
              - 'apps/dpp/**'
              - 'packages/**'
            web:
              - 'apps/web/**'
              - 'packages/**'

  # ============================================
  # Step 2: Run tests for changed components (on both push and PR)
  # These run DIRECTLY (not nested) to report proper status for branch protection
  # ============================================
  test-app:
    name: ğŸ§ª Lint & Type Check
    needs: detect-changes
    if: needs.detect-changes.outputs.app_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: ğŸ”¦ Run linter
        run: bun run lint
        working-directory: ./apps/app
      - name: ğŸª Check TypeScript
        run: NODE_OPTIONS="--max-old-space-size=8192" bun run typecheck
        working-directory: ./apps/app

  test-api:
    name: ğŸ§ª Lint & Type Check (API)
    needs: detect-changes
    if: needs.detect-changes.outputs.api_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: ğŸ”¦ Run linter
        run: bun run lint
        working-directory: ./apps/api
      - name: ğŸª Check TypeScript
        run: bun run typecheck
        working-directory: ./apps/api

  test-jobs:
    name: ğŸ§ª Lint & Type Check (Jobs)
    needs: detect-changes
    if: needs.detect-changes.outputs.jobs_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.2.21"
      - name: Install dependencies
        run: bun install
      - name: ğŸ”¦ Run linter
        run: bun run lint
        working-directory: ./packages/jobs
      - name: ğŸª Check TypeScript
        run: bun run typecheck
        working-directory: ./packages/jobs

  test-dpp:
    name: ğŸ§ª Lint & Type Check (DPP)
    needs: detect-changes
    if: needs.detect-changes.outputs.dpp_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: ğŸ”¦ Run linter
        run: bun run lint
        working-directory: ./apps/dpp
      - name: ğŸª Check TypeScript
        run: bun run typecheck
        working-directory: ./apps/dpp

  test-web:
    name: ğŸ§ª Lint & Type Check (Web)
    needs: detect-changes
    if: needs.detect-changes.outputs.web_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: ğŸ”¦ Run linter
        run: bun run lint
        working-directory: ./apps/web
      - name: ğŸª Check TypeScript
        run: bun run typecheck
        working-directory: ./apps/web

  # ============================================
  # Gate Job: Always runs, reports single status for branch protection
  # ============================================
  all-tests-passed:
    name: âœ… All Tests Passed
    needs: [test-app, test-api, test-jobs, test-dpp, test-web]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          echo "Test results:"
          echo "  test-app: ${{ needs.test-app.result }}"
          echo "  test-api: ${{ needs.test-api.result }}"
          echo "  test-jobs: ${{ needs.test-jobs.result }}"
          echo "  test-dpp: ${{ needs.test-dpp.result }}"
          echo "  test-web: ${{ needs.test-web.result }}"
          
          # If ANY test failed, this gate fails
          if [[ "${{ needs.test-app.result }}" == "failure" ]] || \
             [[ "${{ needs.test-api.result }}" == "failure" ]] || \
             [[ "${{ needs.test-jobs.result }}" == "failure" ]] || \
             [[ "${{ needs.test-dpp.result }}" == "failure" ]] || \
             [[ "${{ needs.test-web.result }}" == "failure" ]]; then
            echo ""
            echo "âŒ One or more tests failed"
            exit 1
          fi
          
          echo ""
          echo "âœ… All tests passed (or were skipped because their code didn't change)"

  # ============================================
  # Step 3: Deploy Web (independent, no dependencies except tests)
  # ============================================
  deploy-web:
    name: ğŸŒ Deploy Web
    needs: [detect-changes, test-web]
    if: |
      always() &&
      (needs.test-web.result == 'success' || needs.test-web.result == 'skipped') &&
      needs.detect-changes.outputs.web_changed == 'true' &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed'
    uses: ./.github/workflows/preview-web.yaml
    with:
      pr_number: ${{ github.event.number }}
    secrets: inherit

  # ============================================
  # Step 4: Deploy App (outputs Vercel URL)
  # ============================================
  deploy-app:
    name: ğŸ“± Deploy App
    needs: [detect-changes, test-app]
    if: |
      always() &&
      (needs.test-app.result == 'success' || needs.test-app.result == 'skipped') &&
      needs.detect-changes.outputs.app_changed == 'true' &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed'
    uses: ./.github/workflows/preview-app.yaml
    with:
      skip_api_wait: ${{ needs.detect-changes.outputs.api_changed == 'true' }}
      pr_number: ${{ github.event.number }}
    secrets: inherit

  # ============================================
  # Step 5: Deploy API (needs App URL from deploy-app)
  # ============================================
  deploy-api:
    name: ğŸ”§ Deploy API
    needs: [detect-changes, test-api, deploy-app]
    # Run if:
    # - API files changed AND tests passed AND app deployment succeeded (or was skipped)
    # - We use always() to run even if deploy-app was skipped
    if: |
      always() &&
      (needs.test-api.result == 'success' || needs.test-api.result == 'skipped') &&
      needs.detect-changes.outputs.api_changed == 'true' &&
      (needs.deploy-app.result == 'success' || needs.deploy-app.result == 'skipped') &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed'
    uses: ./.github/workflows/preview-api.yaml
    with:
      # Pass the app URL from the app deployment (will be empty if app wasn't deployed)
      app_url: ${{ needs.deploy-app.outputs.url || '' }}
      pr_number: ${{ github.event.number }}
    secrets: inherit

  # ============================================
  # Step 6: Deploy Jobs (needs API to be healthy)
  # ============================================
  deploy-jobs:
    name: âš™ï¸ Deploy Jobs
    needs: [detect-changes, test-jobs, deploy-api]
    # Run if:
    # - Jobs files changed AND tests passed AND API deployment succeeded (or was skipped)
    if: |
      always() &&
      (needs.test-jobs.result == 'success' || needs.test-jobs.result == 'skipped') &&
      needs.detect-changes.outputs.jobs_changed == 'true' &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped') &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed'
    uses: ./.github/workflows/preview-jobs.yaml
    with:
      pr_number: ${{ github.event.number }}
    secrets: inherit

  # ============================================
  # Step 7: Deploy DPP (needs API to be healthy)
  # ============================================
  deploy-dpp:
    name: ğŸ“‹ Deploy DPP
    needs: [detect-changes, test-dpp, deploy-api]
    # Run if:
    # - DPP files changed AND tests passed AND API deployment succeeded (or was skipped)
    if: |
      always() &&
      (needs.test-dpp.result == 'success' || needs.test-dpp.result == 'skipped') &&
      needs.detect-changes.outputs.dpp_changed == 'true' &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped') &&
      github.event_name == 'pull_request' &&
      github.event.action != 'closed'
    uses: ./.github/workflows/preview-dpp.yaml
    with:
      pr_number: ${{ github.event.number }}
    secrets: inherit

  # ============================================
  # Summary comment with all deployment URLs
  # ============================================
  summary:
    name: ğŸ“ Post Summary
    needs: [detect-changes, deploy-web, deploy-app, deploy-api, deploy-jobs, deploy-dpp]
    if: always() && github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ’¬ Comment Summary
        uses: actions/github-script@v6
        with:
          script: |
            const appUrl = '${{ needs.deploy-app.outputs.url }}' || null;
            const apiUrl = `https://pr-${{ github.event.number }}-avelero-api.fly.dev`;
            const webUrl = '${{ needs.deploy-web.outputs.url }}' || null;
            const dppUrl = '${{ needs.deploy-dpp.outputs.url }}' || null;
            
            const appChanged = '${{ needs.detect-changes.outputs.app_changed }}' === 'true';
            const apiChanged = '${{ needs.detect-changes.outputs.api_changed }}' === 'true';
            const webChanged = '${{ needs.detect-changes.outputs.web_changed }}' === 'true';
            const dppChanged = '${{ needs.detect-changes.outputs.dpp_changed }}' === 'true';
            const jobsChanged = '${{ needs.detect-changes.outputs.jobs_changed }}' === 'true';
            
            let body = `## ğŸš€ Preview Deployment Summary\n\n`;
            
            if (appChanged) {
              body += `**App:** ${appUrl || 'âŒ Failed'}\n`;
            }
            if (apiChanged) {
              const apiDeployResult = '${{ needs.deploy-api.result }}';
              const apiSuccess = apiDeployResult === 'success';
              body += `**API:** ${apiSuccess ? apiUrl : 'âŒ Failed'}\n`;
            }
            if (webChanged) {
              body += `**Web:** ${webUrl || 'âŒ Failed'}\n`;
            }
            if (dppChanged) {
              body += `**DPP:** ${dppUrl || 'âŒ Failed'}\n`;
            }
            if (jobsChanged) {
              body += `**Jobs:** Deployed to Trigger.dev\n`;
            }
            
            if (!appChanged && !apiChanged && !webChanged && !dppChanged && !jobsChanged) {
              body += `No components were deployed.\n`;
            }
            
            body += `\nPreview environments will auto-delete when PR closes.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================
  # Cleanup when PR is closed
  # ============================================
  cleanup:
    name: ğŸ—‘ï¸ Cleanup Previews
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.2.21"
      - name: Install dependencies
        run: bun install
      - name: ğŸ—‘ï¸ Archive Trigger.dev Preview
        run: bunx trigger.dev@4.0.6 preview archive
        working-directory: ./packages/jobs
        env:
          TRIGGER_ACCESS_TOKEN: ${{ secrets.TRIGGER_ACCESS_TOKEN }}
      # Note: Fly.io preview apps are auto-deleted by the fly-pr-review-apps action
      # Note: Vercel preview deployments are retained but don't incur ongoing costs
