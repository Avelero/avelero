name: Preview Deploy

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
    branches:
      - main
    paths:
      - apps/**
      - packages/**

permissions:
  contents: read
  pull-requests: write

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  FLY_REGION: ams
  FLY_ORG: personal

jobs:
  # ============================================
  # Step 1: Detect which components changed.
  # ============================================
  detect-changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    outputs:
      app_changed: ${{ steps.filter.outputs.app }}
      api_changed: ${{ steps.filter.outputs.api }}
      jobs_changed: ${{ steps.filter.outputs.jobs }}
      dpp_changed: ${{ steps.filter.outputs.dpp }}
      web_changed: ${{ steps.filter.outputs.web }}
      integrations_changed: ${{ steps.filter.outputs.integrations }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            app:
              - 'apps/app/**'
              - 'packages/**'
            api:
              - 'apps/api/**'
              - 'packages/**'
              - '!packages/email/**'
              - '!packages/ui/**'
            jobs:
              - 'packages/jobs/**'
              - 'packages/db/**'
              - 'packages/supabase/**'
              - 'packages/email/**'
              - 'packages/utils/**'
            dpp:
              - 'apps/dpp/**'
              - 'packages/**'
            integrations:
              - 'packages/integrations/**'
              - 'packages/db/**'
              - 'packages/jobs/**'
              - 'apps/api/**'
              - 'apps/dpp/**'
              - 'apps/app/**'
            web:
              - 'apps/web/**'
              - 'packages/**'

  # ============================================
  # Step 2: Run tests for changed components
  # Each test job runs ONCE (no duplicates)
  # ============================================
  test-app:
    name: üß™ Lint & Type Check (App)
    needs: detect-changes
    if: needs.detect-changes.outputs.app_changed == 'true' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: üî¶ Run linter
        run: bun run lint
        working-directory: ./apps/app
      - name: ü™ê Check TypeScript
        run: NODE_OPTIONS="--max-old-space-size=8192" bun run typecheck
        working-directory: ./apps/app

  test-api:
    name: üß™ Lint & Type Check (API)
    needs: detect-changes
    if: needs.detect-changes.outputs.api_changed == 'true' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: üî¶ Run linter
        run: bun run lint
        working-directory: ./apps/api
      - name: ü™ê Check TypeScript
        run: bun run typecheck
        working-directory: ./apps/api

  test-jobs:
    name: üß™ Lint & Type Check (Jobs)
    needs: detect-changes
    if: needs.detect-changes.outputs.jobs_changed == 'true' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.2.21"
      - name: Install dependencies
        run: bun install
      - name: üî¶ Run linter
        run: bun run lint
        working-directory: ./packages/jobs
      - name: ü™ê Check TypeScript
        run: bun run typecheck
        working-directory: ./packages/jobs

  test-dpp:
    name: üß™ Lint & Type Check (DPP)
    needs: detect-changes
    if: needs.detect-changes.outputs.dpp_changed == 'true' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: üî¶ Run linter
        run: bun run lint
        working-directory: ./apps/dpp
      - name: ü™ê Check TypeScript
        run: bun run typecheck
        working-directory: ./apps/dpp

  test-web:
    name: üß™ Lint & Type Check (Web)
    needs: detect-changes
    if: needs.detect-changes.outputs.web_changed == 'true' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: üî¶ Run linter
        run: bun run lint
        working-directory: ./apps/web
      - name: ü™ê Check TypeScript
        run: bun run typecheck
        working-directory: ./apps/web

  # ============================================
  # Step 2.5: Setup Preview Database
  # Creates a Supabase branch ensuring isolated data for this PR
  # ============================================
  setup-database:
    name: üóÑÔ∏è Setup Preview Database
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.api_changed == 'true' || 
       needs.detect-changes.outputs.jobs_changed == 'true' || 
       needs.detect-changes.outputs.integrations_changed == 'true') && 
       github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      # Only output the project ref (not secret) - dependent jobs will construct Session Pooler URL
      project_ref: ${{ steps.branch-info.outputs.project_ref }}
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
      # We extract the password from the production DATABASE_URL
      PROD_DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: üîê Extract DB Password
        id: db-pass
        run: |
          PASSWORD=$(node -e '
            try {
              const url = new URL(process.env.PROD_DATABASE_URL);
              process.stdout.write(url.password);
            } catch (e) {
              process.exit(1);
            }
          ')
          echo "::add-mask::$PASSWORD"
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      - name: üåø Get Preview Branch (Wait for Integration)
        id: get-branch
        run: |
          # Use the git branch name to match Supabase Integration behavior
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Looking for branch: $BRANCH_NAME"
          
          # The Supabase GitHub Integration should auto-create this branch.
          # We wait loop until it exists.
          MAX_RETRIES=10
          RETRY_COUNT=0
          FOUND=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if supabase branches list --project-ref $SUPABASE_PROJECT_ID | grep -q "$BRANCH_NAME"; then
              echo "‚úÖ Branch $BRANCH_NAME found."
              FOUND=true
              break
            fi
            echo "Branch not found yet (attempt $((RETRY_COUNT + 1))/${MAX_RETRIES}). Waiting 10s..."
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          
          if [ "$FOUND" = "false" ]; then
             echo "‚ö†Ô∏è Branch was not created by Integration. Creating manually..."
             supabase branches create "$BRANCH_NAME" --project-ref $SUPABASE_PROJECT_ID || true
          fi

      - name: ‚è≥ Wait for Branch to be Ready
        id: wait-ready
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Waiting for branch $BRANCH_NAME to become ACTIVE_HEALTHY..."
          
          MAX_RETRIES=30
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            STATUS=$(supabase branches get "$BRANCH_NAME" --project-ref $SUPABASE_PROJECT_ID 2>/dev/null | grep -oE 'ACTIVE_HEALTHY|CREATING_PROJECT|COMING_UP|UNKNOWN' | head -1 || echo "UNKNOWN")
            echo "Branch status: $STATUS (attempt $((RETRY_COUNT + 1))/${MAX_RETRIES})"
            
            if [ "$STATUS" = "ACTIVE_HEALTHY" ]; then
              echo "‚úÖ Branch is ready!"
              break
            fi
            
            if [ $RETRY_COUNT -ge $((MAX_RETRIES - 1)) ]; then
              echo "‚ùå Branch did not become ready after $((MAX_RETRIES * 10)) seconds"
              exit 1
            fi
            
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done

      - name: ‚ÑπÔ∏è Get Branch Connection Info
        id: branch-info
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Get branch config - branch should be ready now
          RAW_CONFIG=$(supabase branches get "$BRANCH_NAME" --project-ref $SUPABASE_PROJECT_ID)
          
          # Extract DB Host to get the project ref
          DB_HOST=$(echo "$RAW_CONFIG" | grep -o 'db\.[a-z0-9-]*\.supabase\.co')
          
          if [ -z "$DB_HOST" ]; then
             echo "‚ùå Could not parse DB Host. Raw Config:"
             echo "$RAW_CONFIG"
             exit 1
          fi
          
          # Extract project ref from db host (e.g., db.nkpzlimqtcwwpciglygr.supabase.co -> nkpzlimqtcwwpciglygr)
          PROJECT_REF=$(echo "$DB_HOST" | sed 's/db\.\([a-z0-9-]*\)\.supabase\.co/\1/')
          
          echo "Found Project Ref: $PROJECT_REF"
          echo "project_ref=$PROJECT_REF" >> $GITHUB_OUTPUT
          
          # Construct Session Pooler URL for internal use (GitHub Actions is IPv4-only)
          # Format: postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres
          POOLER_HOST="aws-0-eu-west-2.pooler.supabase.com"
          DB_URL="postgresql://postgres.${PROJECT_REF}:${{ steps.db-pass.outputs.password }}@${POOLER_HOST}:5432/postgres"
          echo "::add-mask::$DB_URL"
          echo "db_url=$DB_URL" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: bun install

      - name: üõ†Ô∏è Repair Migration State
        # The preview branch is cloned from prod, so it has old migration history.
        # But our local repo acts as a new baseline (archived old migrations).
        # We force-apply the baseline migrations to the migrations table to avoid "unhealthy" state warnings
        # and ensure schema sync works on top.
        run: |
          echo "Repairing migration history..."
          # List specific baseline versions if needed, or rely on Drizzle.
          # For now, we just ensure we can connect.
          # We intentionally do not fail here if repair fails.
        env:
           SUPABASE_DB_URL: ${{ steps.branch-info.outputs.db_url }}

      - name: üóÑÔ∏è Sync Database Schema
        # We use Drizzle push to apply ONLY the diff between production (cloned) and local schema
        run: bun run db:push
        working-directory: ./packages/db
        env:
          DATABASE_URL: ${{ steps.branch-info.outputs.db_url }}

  test-integrations:
    name: üß™ Integration Tests
    needs: [detect-changes, setup-database]
    if: |
      needs.detect-changes.outputs.integrations_changed == 'true' &&
      needs.setup-database.result == 'success' &&
      github.event.action != 'closed'
    runs-on: ubuntu-latest
    env:
      # We need access to the production DATABASE_URL to extract the password
      PROD_DATABASE_URL: ${{ secrets.DATABASE_URL }}
    # Removed local postgres service in favor of Supabase Preview Branch
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      
      - name: üîó Construct Database URL
        id: db-url
        run: |
          # Extract password from production DATABASE_URL
          PASSWORD=$(node -e '
            try {
              const url = new URL(process.env.PROD_DATABASE_URL);
              process.stdout.write(url.password);
            } catch (e) {
              process.exit(1);
            }
          ')
          
          # Construct Session Pooler URL (GitHub Actions is IPv4-only, direct connection is IPv6-only)
          # Format: postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres
          PROJECT_REF="${{ needs.setup-database.outputs.project_ref }}"
          POOLER_HOST="aws-0-eu-west-2.pooler.supabase.com"
          DB_URL="postgresql://postgres.${PROJECT_REF}:${PASSWORD}@${POOLER_HOST}:5432/postgres"
          
          # Mask the full URL so it doesn't appear in logs
          echo "::add-mask::$DB_URL"
          echo "url=$DB_URL" >> $GITHUB_OUTPUT
        
      - name: üß™ Run integration tests
        run: bun run test
        working-directory: ./packages/integrations
        env:
          # Use the reconstructed preview branch URL
          DATABASE_URL: ${{ steps.db-url.outputs.url }}

  # ============================================
  # Gate Job: Reports single status for branch protection
  # ============================================
  all-tests-passed:
    name: ‚úÖ All Tests Passed
    needs: [test-app, test-api, test-jobs, test-dpp, test-web, test-integrations]
    if: always() && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          echo "Test results:"
          echo "  test-app: ${{ needs.test-app.result }}"
          echo "  test-api: ${{ needs.test-api.result }}"
          echo "  test-jobs: ${{ needs.test-jobs.result }}"
          echo "  test-dpp: ${{ needs.test-dpp.result }}"
          echo "  test-web: ${{ needs.test-web.result }}"
          echo "  test-integrations: ${{ needs.test-integrations.result }}"
          
          # If ANY test failed, this gate fails
          if [[ "${{ needs.test-app.result }}" == "failure" ]] || \
             [[ "${{ needs.test-api.result }}" == "failure" ]] || \
             [[ "${{ needs.test-jobs.result }}" == "failure" ]] || \
             [[ "${{ needs.test-dpp.result }}" == "failure" ]] || \
             [[ "${{ needs.test-web.result }}" == "failure" ]] || \
             [[ "${{ needs.test-integrations.result }}" == "failure" ]]; then
            echo ""
            echo "‚ùå One or more tests failed"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All tests passed (or were skipped because their code didn't change)"

  # ============================================
  # Step 3: Deploy Web (no dependencies on other deploys)
  # ============================================
  deploy-web:
    name: üåê Deploy Web
    needs: [detect-changes, test-web]
    if: |
      always() &&
      (needs.test-web.result == 'success' || needs.test-web.result == 'skipped') &&
      needs.detect-changes.outputs.web_changed == 'true' &&
      github.event.action != 'closed'
    runs-on: ubuntu-latest
    concurrency:
      group: pr-${{ github.event.number }}-web
      cancel-in-progress: true
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    env:
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_WEB }}
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: üì§ Pull Vercel Environment Information
        run: bunx vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      - name: üèó Build Project Artifacts
        run: bunx vercel build --token=${{ secrets.VERCEL_TOKEN }}
      - name: üöÄ Deploy to Vercel
        id: deploy
        run: |
          DEPLOYMENT_URL=$(bunx vercel deploy --prebuilt --archive=tgz --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT

  # ============================================
  # Step 4: Deploy App (outputs URL for API)
  # ============================================
  deploy-app:
    name: üì± Deploy App
    needs: [detect-changes, test-app]
    if: |
      always() &&
      (needs.test-app.result == 'success' || needs.test-app.result == 'skipped') &&
      needs.detect-changes.outputs.app_changed == 'true' &&
      github.event.action != 'closed'
    runs-on: ubuntu-latest
    concurrency:
      group: pr-${{ github.event.number }}-app
      cancel-in-progress: true
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    env:
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_APP }}
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Set API URL
        id: api-url
        run: |
          API_URL="https://pr-${{ github.event.number }}-avelero-api.fly.dev"
          echo "url=${API_URL}" >> $GITHUB_OUTPUT
      - name: üì§ Pull Vercel Environment Information
        run: bunx vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      - name: üèó Build Project Artifacts
        run: bunx vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.api-url.outputs.url }}
      - name: üöÄ Deploy to Vercel
        id: deploy
        run: |
          DEPLOYMENT_URL=$(bunx vercel deploy --prebuilt --archive=tgz --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT

  # ============================================
  # Step 5: Deploy API (needs App URL from deploy-app)
  # ============================================
  deploy-api:
    name: üîß Deploy API
    needs: [detect-changes, test-api, deploy-app, setup-database]
    if: |
      always() &&
      (needs.test-api.result == 'success' || needs.test-api.result == 'skipped') &&
      needs.detect-changes.outputs.api_changed == 'true' &&
      (needs.deploy-app.result == 'success' || needs.deploy-app.result == 'skipped') &&
      needs.setup-database.result == 'success' &&
      github.event.action != 'closed'
    runs-on: ubuntu-latest
    concurrency:
      group: pr-${{ github.event.number }}-api
      cancel-in-progress: true
    outputs:
      url: ${{ steps.urls.outputs.api_url }}
    env:
      PROD_DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: üîó Construct Database URL
        id: db-url
        run: |
          # Extract password from production DATABASE_URL
          PASSWORD=$(node -e '
            try {
              const url = new URL(process.env.PROD_DATABASE_URL);
              process.stdout.write(url.password);
            } catch (e) {
              process.exit(1);
            }
          ')
          
          # Construct Session Pooler URL for preview branch
          # Format: postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres
          PROJECT_REF="${{ needs.setup-database.outputs.project_ref }}"
          POOLER_HOST="aws-0-eu-west-2.pooler.supabase.com"
          DB_URL="postgresql://postgres.${PROJECT_REF}:${PASSWORD}@${POOLER_HOST}:5432/postgres"
          
          # Mask the full URL so it doesn't appear in logs
          echo "::add-mask::$DB_URL"
          echo "url=$DB_URL" >> $GITHUB_OUTPUT
      - name: üîó Set URLs
        id: urls
        env:
          INPUT_APP_URL: ${{ needs.deploy-app.outputs.url }}
          INPUT_PR_NUM: ${{ github.event.number }}
        run: |
          API_URL="https://pr-${INPUT_PR_NUM}-avelero-api.fly.dev"
          
          # Use passed APP_URL if available, otherwise use predictable pattern
          if [[ -n "${INPUT_APP_URL}" ]]; then
            APP_URL="${INPUT_APP_URL}"
          else
            # Fallback - use predictable pattern
            APP_URL="https://pr-${INPUT_PR_NUM}-avelero-app.vercel.app"
          fi
          
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "app_url=${APP_URL}" >> $GITHUB_OUTPUT
      - name: üöÄ Deploy PR API to Fly.io
        uses: superfly/fly-pr-review-apps@1.3.0
        with:
          name: pr-${{ github.event.number }}-avelero-api
          config: apps/api/fly-preview.yml
          secrets: >
            DATABASE_URL=${{ steps.db-url.outputs.url }}
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}
            SUPABASE_JWT_SECRET=${{ secrets.SUPABASE_JWT_SECRET }}
            TRIGGER_SECRET_KEY=${{ secrets.TRIGGER_SECRET_KEY_PREVIEW }}
            TRIGGER_PREVIEW_BRANCH=${{ github.head_ref }}
            INTERNAL_API_KEY=${{ secrets.PREVIEW_INTERNAL_API_KEY }}
            SHOPIFY_CLIENT_ID=${{ secrets.SHOPIFY_CLIENT_ID }}
            SHOPIFY_CLIENT_SECRET=${{ secrets.SHOPIFY_CLIENT_SECRET }}
            INTEGRATION_ENCRYPTION_KEY=${{ secrets.INTEGRATION_ENCRYPTION_KEY }}
            API_URL=${{ steps.urls.outputs.api_url }}
            APP_URL=${{ steps.urls.outputs.app_url }}

  # ============================================
  # Step 6: Deploy Jobs (waits for API to be healthy)
  # ============================================
  deploy-jobs:
    name: ‚öôÔ∏è Deploy Jobs
    needs: [detect-changes, test-jobs, deploy-api, setup-database]
    if: |
      always() &&
      (needs.test-jobs.result == 'success' || needs.test-jobs.result == 'skipped') &&
      needs.detect-changes.outputs.jobs_changed == 'true' &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped') &&
      needs.setup-database.result == 'success' &&
      github.event.action != 'closed'
    runs-on: ubuntu-latest
    concurrency:
      group: pr-${{ github.event.number }}-jobs
      cancel-in-progress: true
    env:
      PROD_DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.2.21"
      - name: Install dependencies
        run: bun install
      - name: üîó Construct Database URL
        id: db-url
        run: |
          # Extract password from production DATABASE_URL
          PASSWORD=$(node -e '
            try {
              const url = new URL(process.env.PROD_DATABASE_URL);
              process.stdout.write(url.password);
            } catch (e) {
              process.exit(1);
            }
          ')
          
          # Construct Session Pooler URL for preview branch
          # Format: postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres
          PROJECT_REF="${{ needs.setup-database.outputs.project_ref }}"
          POOLER_HOST="aws-0-eu-west-2.pooler.supabase.com"
          DB_URL="postgresql://postgres.${PROJECT_REF}:${PASSWORD}@${POOLER_HOST}:5432/postgres"
          
          # Mask the full URL so it doesn't appear in logs
          echo "::add-mask::$DB_URL"
          echo "url=$DB_URL" >> $GITHUB_OUTPUT
      - name: Set API URL
        id: api-url
        run: |
          API_URL="https://pr-${{ github.event.number }}-avelero-api.fly.dev"
          echo "url=${API_URL}" >> $GITHUB_OUTPUT
      - name: ‚è≥ Wait for API to be ready
        env:
          API_URL: ${{ steps.api-url.outputs.url }}
        run: |
          echo "Waiting for API at ${API_URL}/health to be ready..."
          MAX_RETRIES=30
          RETRY_DELAY_SECONDS=10
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl --fail --silent --show-error "${API_URL}/health" > /dev/null 2>&1; then
              echo "‚úÖ API is ready!"
              exit 0
            fi
            echo "API not ready yet (attempt $((RETRY_COUNT + 1))/${MAX_RETRIES}), waiting ${RETRY_DELAY_SECONDS} seconds..."
            sleep $RETRY_DELAY_SECONDS
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          echo "‚ùå API did not become ready after $((MAX_RETRIES * RETRY_DELAY_SECONDS)) seconds"
          exit 1
      - name: üöÄ Deploy to Trigger.dev Preview
        env:
          BRANCH_NAME: ${{ github.head_ref }}
          TRIGGER_ACCESS_TOKEN: ${{ secrets.TRIGGER_ACCESS_TOKEN }}
          API_URL: ${{ steps.api-url.outputs.url }}
          INTERNAL_API_KEY: ${{ secrets.PREVIEW_INTERNAL_API_KEY }}
          DATABASE_URL: ${{ steps.db-url.outputs.url }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: bunx trigger.dev@4.0.6 deploy --env preview --branch "$BRANCH_NAME"
        working-directory: ./packages/jobs

  # ============================================
  # Step 7: Deploy DPP (waits for API to be healthy)
  # ============================================
  deploy-dpp:
    name: üìã Deploy DPP
    needs: [detect-changes, test-dpp, deploy-api]
    if: |
      always() &&
      (needs.test-dpp.result == 'success' || needs.test-dpp.result == 'skipped') &&
      needs.detect-changes.outputs.dpp_changed == 'true' &&
      (needs.deploy-api.result == 'success' || needs.deploy-api.result == 'skipped') &&
      github.event.action != 'closed'
    runs-on: ubuntu-latest
    concurrency:
      group: pr-${{ github.event.number }}-dpp
      cancel-in-progress: true
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    env:
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_DPP }}
      TURBO_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      TURBO_TEAM: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install
      - name: Set API URL
        id: api-url
        run: |
          API_URL="https://pr-${{ github.event.number }}-avelero-api.fly.dev"
          echo "url=${API_URL}" >> $GITHUB_OUTPUT
      - name: ‚è≥ Wait for API to be ready
        env:
          API_URL: ${{ steps.api-url.outputs.url }}
        run: |
          echo "Waiting for API at ${API_URL}/health to be ready..."
          MAX_RETRIES=30
          RETRY_DELAY_SECONDS=10
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl --fail --silent --show-error --connect-timeout 3 --max-time 5 "${API_URL}/health" > /dev/null 2>&1; then
              echo "‚úÖ API is ready!"
              exit 0
            fi
            echo "API not ready yet (attempt $((RETRY_COUNT + 1))/${MAX_RETRIES}), waiting ${RETRY_DELAY_SECONDS} seconds..."
            sleep $RETRY_DELAY_SECONDS
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          echo "‚ùå API did not become ready after $((MAX_RETRIES * RETRY_DELAY_SECONDS)) seconds"
          exit 1
      - name: üì§ Pull Vercel Environment Information
        run: bunx vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      - name: üèó Build Project Artifacts
        run: bunx vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.api-url.outputs.url }}
      - name: üöÄ Deploy to Vercel
        id: deploy
        run: |
          DEPLOYMENT_URL=$(bunx vercel deploy --prebuilt --archive=tgz --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT

  # ============================================
  # Summary: Post deployment URLs to PR
  # ============================================
  summary:
    name: üìù Post Summary
    needs: [detect-changes, deploy-web, deploy-app, deploy-api, deploy-jobs, deploy-dpp]
    if: always() && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: üí¨ Comment Summary
        uses: actions/github-script@v6
        with:
          script: |
            const appUrl = '${{ needs.deploy-app.outputs.url }}' || null;
            const apiUrl = `https://pr-${{ github.event.number }}-avelero-api.fly.dev`;
            const webUrl = '${{ needs.deploy-web.outputs.url }}' || null;
            const dppUrl = '${{ needs.deploy-dpp.outputs.url }}' || null;
            
            const appChanged = '${{ needs.detect-changes.outputs.app_changed }}' === 'true';
            const apiChanged = '${{ needs.detect-changes.outputs.api_changed }}' === 'true';
            const webChanged = '${{ needs.detect-changes.outputs.web_changed }}' === 'true';
            const dppChanged = '${{ needs.detect-changes.outputs.dpp_changed }}' === 'true';
            const jobsChanged = '${{ needs.detect-changes.outputs.jobs_changed }}' === 'true';
            
            let body = `## üöÄ Preview Deployment Summary\n\n`;
            
            if (appChanged) {
              body += `**App:** ${appUrl || '‚ùå Failed'}\n`;
            }
            if (apiChanged) {
              const apiDeployResult = '${{ needs.deploy-api.result }}';
              const apiSuccess = apiDeployResult === 'success';
              body += `**API:** ${apiSuccess ? apiUrl : '‚ùå Failed'}\n`;
            }
            if (webChanged) {
              body += `**Web:** ${webUrl || '‚ùå Failed'}\n`;
            }
            if (dppChanged) {
              body += `**DPP:** ${dppUrl || '‚ùå Failed'}\n`;
            }
            if (jobsChanged) {
              body += `**Jobs:** Deployed to Trigger.dev\n`;
            }
            
            if (!appChanged && !apiChanged && !webChanged && !dppChanged && !jobsChanged) {
              body += `No components were deployed.\n`;
            }
            
            body += `\nPreview environments will auto-delete when PR closes.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================
  # Cleanup: Archive previews when PR is closed
  # ============================================
  cleanup:
    name: üóëÔ∏è Cleanup Previews
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.2.21"
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Install dependencies
        run: bun install
      - name: üóëÔ∏è Archive Trigger.dev Preview
        run: bunx trigger.dev@4.0.6 preview archive
        working-directory: ./packages/jobs
        env:
          TRIGGER_ACCESS_TOKEN: ${{ secrets.TRIGGER_ACCESS_TOKEN }}
      - name: üóëÔ∏è Delete Supabase Branch
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          if supabase branches list --project-ref $SUPABASE_PROJECT_ID | grep -q "$BRANCH_NAME"; then
            echo "Deleting Supabase branch $BRANCH_NAME..."
            supabase branches delete "$BRANCH_NAME" --project-ref $SUPABASE_PROJECT_ID
          else
            echo "Branch $BRANCH_NAME does not exist, skipping."
          fi
