name: Production Jobs Deploy

permissions:
  contents: read

on:
  push:
    branches:
      - main
    paths:
      - packages/jobs/**
      - packages/db/**
      - packages/supabase/**
      - packages/email/**
      - packages/utils/**
      - .github/workflows/production-jobs.yaml

jobs:
  deploy:
    name: üöÄ Deploy Trigger.dev Jobs to Production
    runs-on: ubuntu-latest
    concurrency: trigger-production
    # Only run on main branch - double protection
    if: github.ref == 'refs/heads/main'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîí Verify main branch deployment
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "‚ùå ERROR: Production deployment attempted from non-main branch!"
            echo "Current ref: ${{ github.ref }}"
            echo "Production deployments are ONLY allowed from the main branch."
            exit 1
          fi
          echo "‚úÖ Verified: Deploying from main branch"

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: üì¶ Install dependencies
        run: bun install

      - name: üî¶ Run linter
        run: bun run lint
        working-directory: ./packages/jobs

      - name: ü™ê Check TypeScript
        run: bun run typecheck
        working-directory: ./packages/jobs

      - name: üöÄ Deploy to Trigger.dev Production
        run: bunx trigger.dev@4.0.6 deploy --env prod
        working-directory: ./packages/jobs
        env:
          TRIGGER_ACCESS_TOKEN: ${{ secrets.TRIGGER_ACCESS_TOKEN }}
          # Production environment variables - synced via syncEnvVars extension
          API_URL: ${{ secrets.API_URL }}
          INTERNAL_API_KEY: ${{ secrets.INTERNAL_API_KEY }}
          # Database and service credentials
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      
      - name: üìù Log production deployment
        run: |
          echo "‚úÖ Successfully deployed to PRODUCTION environment"
          echo ""
          echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT"
          echo "  Environment: prod"
          echo "  Branch: main"
          echo "  API URL: ${{ secrets.API_URL }}"
          echo ""
          echo "üîó View in Trigger.dev:"
          echo "  https://cloud.trigger.dev/projects/v3/proj_mqxiyipljbptdmfeivig/runs?environment=prod"
